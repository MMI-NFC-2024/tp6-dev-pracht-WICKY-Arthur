---
import penguins from "../assets/penguins.json";
import Layout from "../layouts/Layout.astro";
import Menu from "../components/Menu.astro";
import PlotFigure from "../components/PlotFigure.astro";
import * as Plot from "@observablehq/plot";

// Extraire la liste des espèces uniques
const species = [...new Set(penguins.map((c) => c.species))].sort();

// Regrouper les pingouins par espèce
const penguinsBySpecies = {};
species.forEach((specie) => {
    penguinsBySpecies[specie] = penguins.filter((p) => p.species === specie);
});
---

<Layout title="Slider des Pingouins">
    <Menu />
    <main class="max-w-7xl mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8 text-center">
            Graphiques des Pingouins par Espèce
        </h1>

        <!-- Navigation par espèce -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-2">Filtrer par espèce:</h2>
            <ul class="flex flex-wrap gap-2 list-none p-0">
                <li>
                    <a
                        href="#all"
                        class="inline-block px-3 py-2 rounded bg-blue-500 text-white hover:bg-blue-600 transition-colors"
                        id="filter-all">Toutes les espèces</a
                    >
                </li>
                {
                    species.map((specie) => (
                        <li>
                            <a
                                class="inline-block px-3 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors"
                                href={`#${specie.toLowerCase()}`}
                                data-filter={specie.toLowerCase()}
                            >
                                {specie}
                            </a>
                        </li>
                    ))
                }
            </ul>
        </div>

        <!-- Slider des graphiques par espèce -->
        <div class="w-full max-w-6xl mx-auto relative">
            <div class="overflow-hidden" id="slider-container">
                <div
                    class="flex transition-transform duration-300"
                    id="slider-track"
                >
                    {
                        species.map((specie) => (
                            <div
                                class="slide w-full flex-shrink-0 p-2 transition-opacity duration-300"
                                data-species={specie.toLowerCase()}
                            >
                                <div class="bg-white rounded-lg shadow-md h-full p-6 border border-gray-200 hover:shadow-lg transition-shadow">
                                    <h3 class="text-xl font-bold mb-3 text-blue-600">
                                        {specie}
                                    </h3>

                                    {/* Distribution par île */}
                                    <div class="mb-6">
                                        <h4 class="text-lg font-semibold mb-2">
                                            Distribution par île
                                        </h4>
                                        <div class="h-64">
                                            <PlotFigure
                                                options={{
                                                    width: 500,
                                                    height: 240,
                                                    margin: 40,
                                                    grid: true,
                                                    marks: [
                                                        Plot.barY(
                                                            penguinsBySpecies[
                                                                specie
                                                            ],
                                                            Plot.groupX(
                                                                { y: "count" },
                                                                {
                                                                    x: "island",
                                                                    fill: "island",
                                                                    sort: {
                                                                        x: "y",
                                                                        reverse: true,
                                                                    },
                                                                },
                                                            ),
                                                        ),
                                                        Plot.ruleY([0]),
                                                    ],
                                                    style: {
                                                        fontSize: 12,
                                                    },
                                                }}
                                            />
                                        </div>
                                    </div>

                                    {/* Caractéristiques morphologiques */}
                                    <div class="mt-8">
                                        <h4 class="text-lg font-semibold mb-2">
                                            Caractéristiques morphologiques
                                        </h4>
                                        <div class="h-64">
                                            <PlotFigure
                                                options={{
                                                    width: 500,
                                                    height: 240,
                                                    margin: 40,
                                                    grid: true,
                                                    marks: [
                                                        Plot.dot(
                                                            penguinsBySpecies[
                                                                specie
                                                            ],
                                                            {
                                                                x: "culmen_length_mm",
                                                                y: "culmen_depth_mm",
                                                                r: "body_mass_g",
                                                                fill: "sex",
                                                                stroke: "black",
                                                                strokeWidth: 0.5,
                                                                opacity: 0.7,
                                                                title: (d) =>
                                                                    `${d.sex || "Inconnu"}\nMasse: ${d.body_mass_g || "?"}g\nÎle: ${d.island}`,
                                                            },
                                                        ),
                                                        Plot.frame(),
                                                    ],
                                                    x: {
                                                        label: "Longueur du bec (mm)",
                                                        grid: true,
                                                    },
                                                    y: {
                                                        label: "Profondeur du bec (mm)",
                                                        grid: true,
                                                    },
                                                    color: {
                                                        legend: true,
                                                    },
                                                }}
                                            />
                                        </div>
                                    </div>

                                    {/* Statistiques */}
                                    <div class="mt-8">
                                        <h4 class="text-lg font-semibold mb-2">
                                            Statistiques
                                        </h4>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full text-sm">
                                                <thead>
                                                    <tr class="bg-gray-100">
                                                        <th class="text-left p-2">
                                                            Caractéristique
                                                        </th>
                                                        <th class="text-right p-2">
                                                            Moyenne
                                                        </th>
                                                        <th class="text-right p-2">
                                                            Min
                                                        </th>
                                                        <th class="text-right p-2">
                                                            Max
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td class="p-2 border-t">
                                                            Longueur du bec (mm)
                                                        </td>
                                                        <td class="p-2 border-t text-right">
                                                            {Math.round(
                                                                (penguinsBySpecies[
                                                                    specie
                                                                ].reduce(
                                                                    (sum, p) =>
                                                                        sum +
                                                                        (p.culmen_length_mm ||
                                                                            0),
                                                                    0,
                                                                ) /
                                                                    penguinsBySpecies[
                                                                        specie
                                                                    ].filter(
                                                                        (p) =>
                                                                            p.culmen_length_mm,
                                                                    ).length) *
                                                                    10,
                                                            ) / 10}
                                                        </td>
                                                        <td class="p-2 border-t text-right">
                                                            {Math.min(
                                                                ...penguinsBySpecies[
                                                                    specie
                                                                ]
                                                                    .map(
                                                                        (p) =>
                                                                            p.culmen_length_mm,
                                                                    )
                                                                    .filter(
                                                                        Boolean,
                                                                    ),
                                                            )}
                                                        </td>
                                                        <td class="p-2 border-t text-right">
                                                            {Math.max(
                                                                ...penguinsBySpecies[
                                                                    specie
                                                                ]
                                                                    .map(
                                                                        (p) =>
                                                                            p.culmen_length_mm,
                                                                    )
                                                                    .filter(
                                                                        Boolean,
                                                                    ),
                                                            )}
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>

            <div class="flex justify-center gap-4 mt-6">
                <button
                    class="prev bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                    Précédent
                </button>
                <button
                    class="next bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                    Suivant
                </button>
            </div>
        </div>
    </main>
</Layout>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Éléments du slider
        const sliderTrack = document.getElementById("slider-track");
        const slides = document.querySelectorAll(".slide");
        const prevBtn = document.querySelector(".prev");
        const nextBtn = document.querySelector(".next");

        // Éléments de filtrage
        const filterLinks = document.querySelectorAll("[data-filter]");
        const filterAll = document.getElementById("filter-all");

        // Variables du slider
        let currentIndex = 0;
        // Pour ce type de graphique, on montre une seule espèce à la fois
        const slidesToShow = 1;
        let visibleSlides = [...slides];

        // Initialiser le slider
        function initSlider() {
            updateSliderButtons();
            updateSlideVisibility();
        }

        // Mettre à jour l'affichage du slider
        function updateSlider() {
            if (!sliderTrack) return;

            const slideWidth = 100 / slidesToShow;
            sliderTrack.style.transform = `translateX(-${currentIndex * slideWidth}%)`;

            // Mise à jour des boutons
            updateSliderButtons();
        }

        // Mettre à jour les boutons de navigation
        function updateSliderButtons() {
            if (prevBtn) prevBtn.disabled = currentIndex <= 0;
            if (nextBtn)
                nextBtn.disabled =
                    currentIndex >= visibleSlides.length - slidesToShow;
        }

        // Mettre à jour la visibilité des slides selon le filtre
        function updateSlideVisibility(species = null) {
            visibleSlides = [...slides];

            if (species) {
                visibleSlides = [...slides].filter(
                    (slide) => slide.dataset.species === species,
                );
            }

            // Cacher toutes les slides d'abord
            slides.forEach((slide) => {
                slide.classList.add("hidden");
            });

            // Afficher uniquement les slides visibles
            visibleSlides.forEach((slide) => {
                slide.classList.remove("hidden");
            });

            // Reset la position du slider
            currentIndex = 0;
            updateSlider();
        }

        // Gestionnaires d'événements pour les boutons du slider
        if (prevBtn) {
            prevBtn.addEventListener("click", () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    updateSlider();
                }
            });
        }

        if (nextBtn) {
            nextBtn.addEventListener("click", () => {
                if (currentIndex < visibleSlides.length - slidesToShow) {
                    currentIndex++;
                    updateSlider();
                }
            });
        }

        // Filtrage par espèce
        filterLinks.forEach((link) => {
            link.addEventListener("click", (e) => {
                e.preventDefault();

                // Mise à jour de l'état actif des liens
                filterLinks.forEach((l) =>
                    l.classList.remove("bg-blue-500", "text-white"),
                );
                filterLinks.forEach((l) =>
                    l.classList.add("bg-gray-200", "text-gray-800"),
                );
                filterAll.classList.remove("bg-blue-500", "text-white");
                filterAll.classList.add("bg-gray-200", "text-gray-800");

                link.classList.remove("bg-gray-200", "text-gray-800");
                link.classList.add("bg-blue-500", "text-white");

                // Mise à jour du filtre
                const species = link.dataset.filter;
                updateSlideVisibility(species);
            });
        });

        // Filtre "Tous"
        if (filterAll) {
            filterAll.addEventListener("click", (e) => {
                e.preventDefault();

                // Mise à jour de l'état actif des liens
                filterLinks.forEach((l) =>
                    l.classList.remove("bg-blue-500", "text-white"),
                );
                filterLinks.forEach((l) =>
                    l.classList.add("bg-gray-200", "text-gray-800"),
                );

                filterAll.classList.remove("bg-gray-200", "text-gray-800");
                filterAll.classList.add("bg-blue-500", "text-white");

                // Afficher tous les slides
                updateSlideVisibility();
            });
        }

        // Initialisation
        initSlider();
    });
</script>
